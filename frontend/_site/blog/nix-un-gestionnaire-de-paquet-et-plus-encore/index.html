<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles/index.css">
    <link rel="stylesheet" href="/styles/article/index.css">
    <title>Nix : Un gestionnaire de paquet, et plus encore</title>
    
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <meta name="author" content="Bastien Byra" />
    <meta name="robots" content="index, follow">
    <meta name="description" content="Nix est une CLI permettant de créer des environnements à la volée et de gérer facilement des dépendances. Cet article a pour but de la présenter.">
    <meta name="keywords" content="Tech, Nix, NixOS, Environnement informatique, Gestionnaire de paquet, Devops">
    
    <meta property="og:image" content="../../assets/blog/Nix-un-gestionnaire-de-paquet-et-plus-encore/nix-main.png" />
    <meta property="og:description" content="Nix est une CLI permettant de créer des environnements à la volée et de gérer facilement des dépendances. Cet article a pour but de la présenter."/>
    <meta property="og:title" content="Nix : Un gestionnaire de paquet, et plus encore" />
    <script src="/javascript/script.js" refferer></script>
    
    <link
			href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css"
			rel="stylesheet"
		/>

    <script data-goatcounter="https://bastienbyra.goatcounter.com/count"
        async src="//gc.zgo.at/count.js">
    </script>
    
  </head>
  <body>
    <div class="container">
      <header>
    <div class="header-main">
        <a href="/" class="header-main-link">
            Bastien Byra
        </a>
        <div class="header-right">
            <a href="/">Blog</a>
            <a href="/a-propos">A propos</a>
        </div>
        <svg id="toggle-menu-header" class="mobile-header-right" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-menu-2" height="44" width="44">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <line x1="4" y1="6" x2="20" y2="6" />
            <line x1="4" y1="12" x2="20" y2="12" />
            <line x1="4" y1="18" x2="20" y2="18" />
        </svg>
    </div>
    <div class="toggle-receiver-header header-mobile-row-invisible">
        <a href="/">Blog</a>
        <a href="/a-propos" class="last-link">A propos</a>
    </div>
    
</header>
      <div class="layout-border">
      
    <div class="article-container">
        <img class="article-image" src="../../assets/blog/Nix-un-gestionnaire-de-paquet-et-plus-encore/nix-main.png" alt="" />

        <div class="article-intro">
            <p class="article-date">21 JUILLET 2024 | TECH, NIX, ENVIRONNEMENT, GESTIONNAIRE DE PAQUET</p>
            <h1 class="article-title">Nix : Un gestionnaire de paquet, et plus encore</h1>
            <p class="article-description">Nix est une CLI permettant de créer des environnements à la volée et de gérer facilement des dépendances. Cet article a pour but de la présenter.</p>
        </div>
        
        <div class="article-content">
            <h2 id="table-des-mati%C3%A8res" tabindex="-1">Table des matières</h2>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#cest-quoi-nix">C’est quoi Nix</a></li>
<li><a href="#comment-installer-nix">Comment installer Nix</a>
<ul>
<li><a href="#linux-et-wsl2">Linux et WSL2</a></li>
<li><a href="#macos">MacOS</a></li>
</ul>
</li>
<li><a href="#environnement-de-d%C3%A9veloppement-nodejs-java-angular">Exemples : Environnement de développement : NodeJS - Java / Angular</a></li>
<li><a href="#nixos">NixOS</a>
<ul>
<li><a href="#installer-et-configurer-des-outils">Installer et configurer des outils</a></li>
</ul>
</li>
<li><a href="#aquaproj-asdf-mise-devenv">Aquaproj, asdf, mise, devenv…</a></li>
</ul>
<h2 id="introduction" tabindex="-1">Introduction</h2>
<p>Avez-vous déjà eu des problèmes avec des packages ?</p>
<p>Un package qui va installer tout un tas de choses dont on n’a pas la moindre idée de ce que c’est, ou encore un package qui vous installe une vieille version d’un outil (je parle de toi NodeJS !).</p>
<p>Peut-être que vous alternez fréquemment d’OS et que vous vous retrouvez souvent perdus quant à la manière d'installer ce que vous voulez ; noms de packages différents, versions différentes…</p>
<p>Peut-être n’avez-vous besoin de ces packages que pour un court instant, mais vous êtes tête en l’air, et vous les oubliez ?</p>
<p>Je pourrais continuer encore longtemps, mais là où je veux en venir, c’est que ce serait bien d’avoir un gestionnaire de paquets qui permettrait d’installer temporairement des paquets, facilement supprimables, qui fonctionne indépendamment de l'OS, et soyons fou ; Qui permettrait même de créer des environnements (de développement par exemple) pour des équipes de développeurs.</p>
<p>Si certaines de ces choses vous intéressent, je pense que Nix peut vous intéresser.</p>
<h2 id="cest-quoi-nix" tabindex="-1">C’est quoi Nix</h2>
<p>Pour présenter simplement Nix : C’est un gestionnaire de paquets indépendant de l’OS qui permet de configurer la liste des paquets que l’on veut installer sur notre système à partir d’un fichier de configuration. Son but est de permettre de créer des environnements (de développement par exemple) reproductibles, fonctionnels indépendamment de la machine et de l’OS, facilement partageables, avec la possibilité de rollback en cas de problème si un package casse le système.</p>
<p><strong>TLDR :</strong></p>
<ul>
<li>Si un package installé sur un Ubuntu fonctionne, alors il fonctionnera sur tous les autres OS.</li>
<li>Si la mise à jour d’un paquet casse le système, on peut rollback facilement.</li>
<li>Permet de créer des environnements à la volée et de les partager à d'autres personnes.</li>
</ul>
<p>En bref, Nix c’est ; Fiabilité, reproductibilité, le tout étant déclarative.</p>
<h2 id="comment-installer-nix" tabindex="-1">Comment installer Nix</h2>
<p>L’installation de Nix varie légèrement selon votre système d’exploitation. Voici les instructions pour les principaux OS.</p>
<h3 id="linux-et-wsl2">Linux et WSL2</h3>
<p>Pour installer Nix sur Linux ou WSL2, exécutez la commande suivante dans votre terminal :</p>
<p>Tous les utilisateurs :</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">sh</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token function">curl</span> <span class="token parameter variable">-L</span> https://nixos.org/nix/install<span class="token punctuation">)</span> <span class="token parameter variable">--daemon</span></code></pre>
<p>Utilisateur courant :</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">sh</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token function">curl</span> <span class="token parameter variable">-L</span> https://nixos.org/nix/install<span class="token punctuation">)</span> --no-daemon</code></pre>
<h3 id="macos">MacOS</h3>
<p>Pour les utilisateurs de Mac, vous n’avez qu’un moyen de l’installer (Tous les utilisateurs de la machine)</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">sh</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token function">curl</span> <span class="token parameter variable">-L</span> https://nixos.org/nix/install<span class="token punctuation">)</span></code></pre>
<p>Pour voir l’ensemble des méthodes d’installation ; <a href="https://nixos.org/download/">https://nixos.org/download</a></p>
<h2 id="environnement-de-développement-nodejs-java-angular" tabindex="-1">Exemple : Environnement de développement : NodeJS - Java / Angular</h2>
<p>Parlons peu, parlons bien ; Voyons comment installer des packages et créer un environnement de développement et installer divers outils pour configurer son PC ou son serveur.</p>
<p>La liste des packages disponibles est disponible ici : <a href="https://search.nixos.org/packages">https://search.nixos.org/packages</a></p>
<p>Prenons un exemple simple : Nous avons une équipe de développement qui travaille sur un projet ayant un Frontend en NodeJS / Angular, un Backend Java 17 / Spring. L'équipe a aussi besoin d'un outil pour interagir avec un S3.</p>
<p>Pour créer cet environnement de développement, on peut utiliser la commande <code>nix-shell -p</code> en spécifiant les packages nécessaires à cet environnement.</p>
<pre class="language-bash"><code class="language-bash">nix-shell <span class="token parameter variable">-p</span> nodejs jdk17 maven rclone</code></pre>
<p>Voyons un peu les packages suivants :</p>
<ul>
<li>nodejs installe la LTS de Node, NPM, NPX et Corepack</li>
<li>jdk17 installe le Java Development Kit dans sa version 17</li>
<li>maven installe la LTS de Maven</li>
<li>rclone installe la dernière version de Rclone</li>
</ul>
<p>Il est possible de spécifier des versions ou non pour chaque package, comme je l’ai fait avec le JDK, j’aurais pu ne pas spécifier de version, auquel cas j’aurais installé le JDK 21.</p>
<p>Il y a aussi un second moyen pour créer un environnement, en utilisant une approche déclarative dans laquelle on définit dans un fichier nommé shell.nix ce que l’on veut.</p>
<p>Reprenons l’exemple précédent.</p>
<pre class="language-json"><code class="language-json">let
  nixpkgs = fetchTarball <span class="token string">"https://github.com/NixOS/nixpkgs/tarball/nixos-24.05"</span>;
  pkgs = import nixpkgs <span class="token punctuation">{</span> config = <span class="token punctuation">{</span><span class="token punctuation">}</span>; overlays = <span class="token punctuation">[</span><span class="token punctuation">]</span>; <span class="token punctuation">}</span>;
in
  pkgs.mkShellNoCC <span class="token punctuation">{</span>
    packages = with pkgs; <span class="token punctuation">[</span>
      nodejs
      jdk17
      maven
      rclone
    <span class="token punctuation">]</span>;
  <span class="token punctuation">}</span></code></pre>
<p>Dans le premier bloc de code, on indique à notre script d’installer la dernière version (24.05) de nixpkgs (Répertoire des paquets de Nix), que l’on importe ensuite dans la variable pkgs. On utilise ensuite la fonction mkShellNoCC pour récupérer les paquets que l’on souhaite.</p>
<p>On lance notre environnement en utilisant la commande <code>nix-shell shell.nix</code></p>
<p>Juste ainsi, nous avons un environnement prêt pour programmer, un environnement très simple, mais fonctionnel, et surtout facile à mettre en place.</p>
<h2 id="nixos" tabindex="-1">NixOS</h2>
<p>Nix permet d’avoir un gestionnaire de paquets qui nous permet d’un coup d'œil de savoir les dépendances du système, pour peu que les dépendances soient toutes installées via Nix.</p>
<p>Peut-être que vous voudriez adopter cette façon de faire sur l’entièreté d’un OS, un OS dans lequel tous les paquets que l’on veut sont déclarés à l’avance, et dans lequel on peut savoir d’un coup d'œil tout ce qu’il y a dedans, pas de place à l’aléatoire.</p>
<p>Si c’est le cas, NixOS est l’un de vos meilleurs paris, la philosophie de Nix, mais appliquée à l'entièreté de la machine.</p>
<h3 id="installer-et-configurer-des-outils">Installer et configurer des outils</h3>
<p>On peut aussi utiliser Nix pour installer différents outils : NGINX, Keycloak, NextCloud, Gitlab, LiveBook, Apache, ZSH, Kubernetes... et une multitude d'autres outils.</p>
<p>Prenons l’exemple de NGINX, je veux avec Nix installer la dernière version de NGINX, qui va écouter sur les ports 80 et 443. Je veux qu’il redirige les requêtes du port 80 sur 443 et écoute sur le chemin “/”. En prime, je veux aussi qu’il me génère un certificat SSL valide.</p>
<p>Vous pouvez trouver la documentation des différents outils sur le site officiel de Nix en cherchant l’outil voulu ; Ici NGINX : <a href="https://nixos.wiki/index.php?search=Nginx&amp;title=Special%3ASearch&amp;profile=default&amp;fulltext=1">https://nixos.wiki/index.php?search=Nginx&amp;title=Special%3ASearch&amp;profile=default&amp;fulltext=1</a></p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span> pkgs ? import &lt;nixpkgs> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token operator">:</span>
<span class="token punctuation">{</span>
  services.nginx = <span class="token punctuation">{</span>
    enable = <span class="token boolean">true</span>;
    virtualHosts.<span class="token string">"bastienbyra.fr"</span> = <span class="token punctuation">{</span>
      addSSL = <span class="token boolean">true</span>;
      enableACME = <span class="token boolean">true</span>;
      forceSSL = <span class="token boolean">true</span>;
      root = <span class="token string">"/website"</span>;
    <span class="token punctuation">}</span>;
  <span class="token punctuation">}</span>;
  # Permet de récupérer automatiquement un certificat SSL + Envoyer un mail pour renouveler le certificat SSL
  security.acme = <span class="token punctuation">{</span>
    acceptTerms = <span class="token boolean">true</span>;
    defaults.email = <span class="token string">"youremail@address.com"</span>;
    certs = <span class="token punctuation">{</span>
      <span class="token string">"bastienbyra.fr"</span>.email = <span class="token string">"youremail@address.com"</span>;
    <span class="token punctuation">}</span>;
  <span class="token punctuation">}</span>;
<span class="token punctuation">}</span></code></pre>
<p>Pour expliquer ce que fait cette configuration NGINX :</p>
<pre class="language-json"><code class="language-json">services.nginx.enable = <span class="token boolean">true</span></code></pre>
<p>On indique que l’on veut lancer le serveur NGINX</p>
<pre class="language-json"><code class="language-json">virtualHosts.<span class="token string">"bastienbyra.fr"</span>.addSSL
virtualHosts.<span class="token string">"bastienbyra.fr"</span>.enableACME
virtualHosts.<span class="token string">"bastienbyra.fr"</span>.forceSSL</code></pre>
<p>Cette configuration est liée au port 443 et au SSL ;</p>
<ul>
<li>virtualHosts.&quot;<a href="http://bastienbyra.fr">bastienbyra.fr</a>&quot;.addSSL indique que l’on veut écouter sur les ports 80 et 443</li>
<li>virtualHosts.&quot;<a href="http://bastienbyra.fr">bastienbyra.fr</a>&quot;.enableACME permet de générer automatiquement un certificat SSL avec Let’s Encrypt</li>
<li>virtualHosts.&quot;<a href="http://bastienbyra.fr">bastienbyra.fr</a>&quot;.forceSSL permet de faire une redirection HTTP vers HTTPS</li>
</ul>
<pre class="language-json"><code class="language-json">security.acme.acceptTerms = <span class="token boolean">true</span>;
security.acme.defaults.email = <span class="token string">"youremail@address.com"</span>;
security.acme.certs.<span class="token string">"bastienbyra.fr"</span>.email = <span class="token string">"youremail@address.com"</span>;</code></pre>
<p>Cette configuration est liée au protocole ACME / Let’s Encrypt</p>
<ul>
<li>security.acme.acceptTerms permet d’accepter les conditions de service de Let’s Encrypt</li>
<li>security.acme.defaults.email et security.acme.certs.<email>.email indiquent l’email utilisé pour créer le certificat et envoyer les mails de rappel de renouvellement du certificat</li>
</ul>
<p>Juste comme ça nous avons un serveur web prêt à déployer un site web au monde entier.</p>
<p>Liste des champs disponibles pour configurer NGINX :<br>
<a href="https://search.nixos.org/options?channel=24.05&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=services.nginx">https://search.nixos.org/options?channel=24.05&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=services.nginx</a>.</p>
<p>Liste des champs disponibles pour configurer l’ACME :<br>
<a href="https://search.nixos.org/options?channel=24.05&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=security.acme">https://search.nixos.org/options?channel=24.05&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=security.acme</a>.</p>
<p>Une liste d’outils avec des exemples de configuration :<br>
<a href="https://nixos.org/manual/nixos/stable/#ch-configuration">https://nixos.org/manual/nixos/stable/#ch-configuration</a></p>
<h2 id="aquaproj-asdf-mise-devenv" tabindex="-1">Aquaproj, asdf, mise, devenv…</h2>
<p>Nix est un des nombreux gestionnaires de paquets ayant pour but de créer des environnements. Une multitude d’autres projets prennent à bras-le-corps ce problème et proposent leur version ; certains outils s’orientent plus sur l’aspect “dev”, d’autres sur la mise en place complète d’un système, certains proposent des fonctionnalités que d’autres n’ont pas.</p>
<p>Mais en fin de compte, tous permettent de créer des environnements, à la volée ou persistants, à vous de voir lequel semble le mieux satisfaire votre besoin.</p>
<p>Pour mon usage, je ne me soucie pas vraiment de quel outil j’utilise. Nix propose plus de 100 000 paquets et a un site web qui répertorie la liste des paquets qu’il a, ce qui rend la recherche d’un paquet facile. C’est tout ce dont j’ai besoin pour le moment, donc mon choix se porte sur lui.</p>
<p>En fonction de si vous voulez l’utiliser pour créer des environnements sur votre PC, des serveurs, dans une CI/CD ou autre chose, prenez l’outil qui semble le mieux répondre à votre besoin.</p>

        </div>

        <hr>
        
        <div class="article-end">
            <p>Merci d'avoir lu cet article, n'hésitez pas à jeter un coup d'oeil aux autres articles.</p>
            <a class="link-to-articles" href="https://bastienbyra.fr/">Mes autres articles.</a>
            <div class="article-social-network">
                <p>par <span class="blueviolet">Bastien BYRA</span></p>
                <div class="article-network-image">
                    <a href="https://github.com/BastienBYRA">
                        <img src="/assets/social_network/Github.png" alt="Logo de Github" />
                    </a>
                    <a href="https://www.linkedin.com/in/bastien-byra-848998209/">
                        <img src="/assets/social_network/Linkedin.png" alt="Logo de Linkedin" />
                    </a>
                </div>
            </div>
        </div>
    </div>

      </div>
    </div>
  </body>
</html>