<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles/index.css">
    <link rel="stylesheet" href="/styles/article/index.css">
    <title>S√©curiser vos conteneurs avec le Distroless</title>
    
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <meta name="author" content="Bastien Byra" />
    <meta name="robots" content="index, follow">
    <meta name="description" content="Le distroless est une m√©thode de s√©curisation des conteneurs que j&#39;explore dans cet article, nous allons voir les solutions disponibles pour le mettre en place et la mani√®re de l&#39;utiliser.">
    <meta name="keywords" content="Conteneurs docker, s√©curite, distroless, image distroless, mise en place de containers docker distroless">
    
    <meta property="og:image" content="../../assets/blog/Securiser-vos-conteneurs-avec-le-distroless/securiser-vos-conteneurs-avec-le-distroless-thumbnail.png" />
    <meta property="og:description" content="Le distroless est une m√©thode de s√©curisation des conteneurs que j&#39;explore dans cet article, nous allons voir les solutions disponibles pour le mettre en place et la mani√®re de l&#39;utiliser."/>
    <meta property="og:title" content="S√©curiser vos conteneurs avec le Distroless" />
    <script src="/javascript/script.js" refferer></script>
    
    <link
			href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css"
			rel="stylesheet"
		/>

    <script data-goatcounter="https://bastienbyra.goatcounter.com/count"
        async src="//gc.zgo.at/count.js">
    </script>
    
  </head>
  <body>
    <div class="container">
      <header>
    <div class="header-main">
        <a href="/" class="header-main-link">
            Bastien Byra
        </a>
        <div class="header-right">
            <a href="/">Blog</a>
            <a href="/a-propos">A propos</a>
        </div>
        <svg id="toggle-menu-header" class="mobile-header-right" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icon-tabler-menu-2" height="44" width="44">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <line x1="4" y1="6" x2="20" y2="6" />
            <line x1="4" y1="12" x2="20" y2="12" />
            <line x1="4" y1="18" x2="20" y2="18" />
        </svg>
    </div>
    <div class="toggle-receiver-header header-mobile-row-invisible">
        <a href="/">Blog</a>
        <a href="/a-propos" class="last-link">A propos</a>
    </div>
    
</header>
      <div class="layout-border">
      
    <div class="article-container">
        <img class="article-image" src="../../assets/blog/Securiser-vos-conteneurs-avec-le-distroless/securiser-vos-conteneurs-avec-le-distroless-thumbnail.png" alt="" />

        <div class="article-intro">
            <p class="article-date">29 OCTOBRE 2024 | CONTENEURS, DISTROLESS, SECURITE</p>
            <h1 class="article-title">S√©curiser vos conteneurs avec le Distroless</h1>
            <p class="article-description">Le distroless est une m√©thode de s√©curisation des conteneurs que j&#39;explore dans cet article, nous allons voir les solutions disponibles pour le mettre en place et la mani√®re de l&#39;utiliser.</p>
        </div>
        
        <div class="article-content">
            <h2 id="table-des-mati%C3%A8res" tabindex="-1">Table des mati√®res</h2>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#from-scratch">From Scratch</a></li>
<li><a href="#les-conteneurs-distroless-de-google">Les conteneurs Distroless de Google</a>
<ul>
<li><a href="#exemple-google-container">Exemple</a></li>
</ul>
</li>
<li><a href="#wolfi-l-os-pour-les-conteneurs">Wolfi : l'OS pour les conteneurs</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#liens-utiles">Liens utiles</a></li>
</ul>
<h2 id="introduction" tabindex="-1">Introduction</h2>
<p>Lorsqu'on cr√©e une image Docker, on utilise une image qui servira de base.</p>
<p>Celle-ci peut √™tre :</p>
<ul>
<li>une distribution Linux comme Debian, Ubuntu ou Alpine,</li>
<li>une image contenant le langage de programmation n√©cessaire √† notre projet,</li>
<li>une image contenant un outil requis pour le projet.</li>
</ul>
<p>Il existe de nombreuses options, mais l'essentiel √† retenir est que toutes les images Docker sont bas√©es sur une autre, et il est probable que cette base soit une distribution Linux ou une image qui en utilise une.</p>
<p>Mais est-il possible de se passer compl√®tement d'une distribution Linux ? Apr√®s tout, si le but est de d√©ployer une application ou un service, n‚Äôy aurait-il pas des avantages √† se d√©tacher de cette base Linux ?</p>
<p>Ne pas utiliser de distribution Linux offrirait plusieurs avantages :</p>
<ul>
<li>une surface d'attaque r√©duite,</li>
<li>un temps de construction plus rapide,</li>
<li>un d√©ploiement plus rapide,</li>
<li>une image plus l√©g√®re.</li>
</ul>
<p>Des avantages int√©ressants, mais est-ce m√™me possible ?</p>
<h2 id="from-scratch" tabindex="-1">From Scratch</h2>
<p>L'image Debian, par exemple, utilise &quot;Scratch&quot; comme base. C'est l'image la plus minimale possible, d√©pourvue de tout.</p>
<p>Cette image &quot;vide&quot; n'a g√©n√©ralement qu'une seule fonction : lancer un binaire statique, comme l'ex√©cutable de votre application.</p>
<p>Cependant, cette m√©thode implique que votre programme ne doit d√©pendre d'aucune autre ressource : pas de runtime, de biblioth√®que ou de d√©pendance externe. Le programme doit √™tre enti√®rement autonome et capable d'√™tre compil√© en un fichier binaire unique.</p>
<p>Ce n‚Äôest g√©n√©ralement pas r√©aliste, car la plupart des programmes ont besoin de biblioth√®ques, qu‚Äôon le veuille ou non.</p>
<blockquote>
<p>Utiliser scratch, c‚Äôest ne pas avoir de shell, pas de syst√®me de fichiers... rien.</p>
<p>Vous savez exactement ce que contient votre image : rien. C‚Äôest √† vous d‚Äôajouter ce dont vous avez besoin.</p>
</blockquote>
<h2 id="les-conteneurs-distroless-de-google" tabindex="-1">Les conteneurs Distroless de Google</h2>
<p>Maintenant que nous avons fait ce d√©tour, parlons du sujet principal : les conteneurs <strong>distroless</strong> (sans distribution Linux), comme ceux propos√©s par Google.</p>
<p>üëâ <a href="https://github.com/GoogleContainerTools/distroless">https://github.com/GoogleContainerTools/distroless</a></p>
<p>Les images ‚Äúdistroless‚Äù n‚Äôembarquent pas de distribution Linux ni les nombreux paquets qui l‚Äôaccompagnent, adoptant ainsi de bonnes pratiques pour garantir des images s√©curis√©es et l√©g√®res.</p>
<p>Elles sont d√©pourvues de la multitude de paquets qui accompagnent habituellement un OS, et permettent leur utilisation en tant qu‚Äôutilisateur non-root.</p>
<p>On trouve des images pour plusieurs langages : Python 3, Java 17, Java 21, Node 20, ainsi que des images plus g√©n√©rales comme static pour les programmes compil√©s en fichiers binaires uniques (C, Golang, etc.).</p>
<p>Prenons l'exemple de python. Google propose l'image <code>gcr.io/distroless/python3-debian12</code>.</p>
<blockquote>
<p><strong>Note :</strong></p>
<p>Le distroless (de Google) est bas√© sur Debian, cependant, il est bas√© sur une version modifi√©e de celui-ci, ne conservant que l‚Äôessentiel pour ex√©cuter les programmes dans de bonnes conditions.</p>
</blockquote>
<p>Le r√©sultat : des images tr√®s l√©g√®res, de l‚Äôordre de 2 Mo, soit quatre fois moins que la taille d‚Äôune image Alpine de base, en plus d‚Äôavoir une surface d‚Äôattaque diminu√©e.</p>
<p>Le distroless pour faire une analogie, c'est comme le serverless ; Le serverless utilise des serveurs, et le distroless utilise une distro Linux.</p>
<p>L'image Python, par exemple, contient uniquement par d√©faut :</p>
<ul>
<li>la biblioth√®que ca-certificates,</li>
<li><code>/etc/passwd</code> pour l'utilisateur root,</li>
<li>le r√©pertoire <code>/tmp</code>,</li>
<li>les biblioth√®ques tzdata, glibc, et libssl,</li>
<li>Python 3 et ses d√©pendances.</li>
</ul>
<h3 id="exemple-google-container">Exemple</h3>
<p>Prenons l'exemple d'une application Python Flask, le code de cette application est tr√®s simpliste, exposant une route.</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"&lt;p>Hello, World!&lt;/p>"</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span></code></pre>
<p>Pour cr√©er une image Distroless, je vais me baser sur <a href="https://github.com/GoogleContainerTools/distroless/blob/main/examples/python3/Dockerfile">l'exemple fourni par Google.</a></p>
<p>Ce qui nous donne ceci :</p>
<pre class="language-dockerfile"><code class="language-dockerfile"><span class="token comment"># √âtape 1 : Construction des d√©pendances et de l'application</span>
<span class="token instruction"><span class="token keyword">FROM</span> python:3.12-slim <span class="token keyword">AS</span> build-env</span>

<span class="token comment"># Copier les fichiers du projet dans le conteneur</span>
<span class="token instruction"><span class="token keyword">COPY</span> . /app</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>

<span class="token comment"># Installer les d√©pendances du projet</span>
<span class="token instruction"><span class="token keyword">RUN</span> pip install .</span>

<span class="token comment"># √âtape 2 : Image Distroless</span>
<span class="token instruction"><span class="token keyword">FROM</span> gcr.io/distroless/python3-debian12</span>

<span class="token comment"># Copier l'application et les d√©pendances depuis l'√©tape de construction</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build-env</span></span> /app /app</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build-env</span></span> /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">ENV</span> PYTHONPATH=/usr/local/lib/python3.12/site-packages</span>

<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"main.py"</span>]</span></code></pre>
<p>La structure de fichier de l'application :</p>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">.</span>
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ pyproject.toml
‚îî‚îÄ‚îÄ uv.lock</code></pre>
<p>Je build mon image, et je lance mon conteneur !</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">docker</span> buildx build <span class="token parameter variable">--quiet</span> <span class="token parameter variable">-t</span> mon-container-python-distroless <span class="token builtin class-name">.</span>
sha256:98c5333dc36b1cf3698811b36acaf5dd1fe8d945c7c191b01abfca4228cf8fa4

$ <span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">80</span>:80 <span class="token parameter variable">--name</span> py mon-container-python-distroless
a44d954e93215d9cb52beda7a4c84a155d5d741579873e11ee86e5a8119ec3b7

$ <span class="token function">docker</span> <span class="token function">ps</span>
CONTAINER ID   IMAGE                          COMMAND                 CREATED          STATUS          PORTS                 NAMES
a44d954e9321   mon-container-python-distroless   <span class="token string">"/usr/bin/python3.11‚Ä¶"</span>   <span class="token number">12</span> seconds ago   Up <span class="token number">11</span> seconds   <span class="token number">0.0</span>.0.0:80-<span class="token operator">></span><span class="token number">80</span>/tcp   py</code></pre>
<p>Mon conteneur est accessible en ligne depuis mon navigateur, et je n'ai aucun moyen de p√©n√©trer dedans.</p>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> py <span class="token function">sh</span>
OCI runtime <span class="token builtin class-name">exec</span> failed: <span class="token builtin class-name">exec</span> failed: unable to start container process: exec: <span class="token string">"sh"</span><span class="token builtin class-name">:</span> executable <span class="token function">file</span> not found <span class="token keyword">in</span> <span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span> unknown

$ <span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> py <span class="token function">bash</span>
OCI runtime <span class="token builtin class-name">exec</span> failed: <span class="token builtin class-name">exec</span> failed: unable to start container process: exec: <span class="token string">"bash"</span><span class="token builtin class-name">:</span> executable <span class="token function">file</span> not found <span class="token keyword">in</span> <span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span> unknown</code></pre>
<p>Et si on v√©rifiait le nombre de failles que trouve <code>docker scout quickview</code> dans notre image compar√©e √† l‚Äôimage python3.12-slim ?</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Python 3.12 slim	</span>
$ <span class="token function">docker</span> scout quickview python:3.12-slim
  Target             ‚îÇ python:3.12-slim ‚îÇ 0C 0H 1M 28L
  digest             ‚îÇ   311c6c7090a5   ‚îÇ
  Base image         ‚îÇ     debian       ‚îÇ 0C 0H 1M 23L
  Updated base image ‚îÇ     debian       ‚îÇ 0C 0H 1M 23L

<span class="token comment"># Mon application Flask</span>
$ <span class="token function">docker</span> scout quickview mon-container-python-distroless
  Target     ‚îÇ mon-container-python-distroless:latest ‚îÇ 0C 0H 0M 0L
  digest     ‚îÇ              9b7fb764deb2              ‚îÇ
  Base image ‚îÇ    distroless/static-debian12:latest   ‚îÇ 0C 0H 0M 0L</code></pre>
<p>Juste comme √ßa, j'ai une image Distroless fonctionnelle, s√©curis√©e et pr√™te √† l'emploi.</p>
<blockquote>
<p><strong>Note</strong> :</p>
<p>Il est important de noter que ces images ne contiennent ni shell, ni gestionnaire de paquets, ce qui peut compliquer le d√©bogage si n√©cessaire (et cela arrivera in√©vitablement, loi de Murphy oblige).</p>
</blockquote>
<h2 id="wolfi-l-os-pour-les-conteneurs" tabindex="-1">Wolfi : l'OS pour les conteneurs</h2>
<p>Wolfi est un OS con√ßu pour les conteneurs et le cloud de mani√®re g√©n√©rale. Il vise √† produire des images sans vuln√©rabilit√©.</p>
<p>üëâ <a href="https://github.com/wolfi-dev">https://github.com/wolfi-dev</a></p>
<p>Wolfi s‚Äôinscrit √©galement dans la dynamique distroless. Alors que les conteneurs distroless de Google fournissent des images pr√™tes √† l‚Äôemploi pour des cas sp√©cifiques, Wolfi se veut plus g√©n√©ral et peut √™tre utilis√© quel que soit votre projet.</p>
<p>Il est possible de cr√©er des images avec Wolfi de deux fa√ßons :</p>
<p>La m√©thode standard via l‚Äôutilisation d‚Äôun Dockerfile, ou avec les outils in-house apko et melange. Wolfi peut aussi cr√©er des images plus classiques, incluant un shell, un gestionnaire de fichiers, etc., c‚Äôest notamment le cas quand on cr√©e une image via l‚Äôutilisation d‚Äôun Dockerfile.</p>
<blockquote>
<p><strong>Note</strong> :</p>
<p>G√©n√©rer une image avec le Dockerfile : <a href="https://edu.chainguard.dev/open-source/wolfi/wolfi-with-dockerfiles/">https://edu.chainguard.dev/open-source/wolfi/wolfi-with-dockerfiles/</a> G√©n√©rer une image avec apko et melange : <a href="https://edu.chainguard.dev/open-source/build-tools/apko/getting-started-with-apko/">https://edu.chainguard.dev/open-source/build-tools/apko/getting-started-with-apko/</a></p>
</blockquote>
<h2 id="conclusion" tabindex="-1">Conclusion</h2>
<p>Avez-vous besoin de conteneurs distroless ? C'est une question l√©gitime √† se poser.</p>
<p>Les distroless offrent un √©norme avantage : la s√©curit√©. L'image √©tant presque vierge, les risques li√©s aux d√©pendances inutiles ou aux failles de s√©curit√© sont r√©duits au minimum, en plus de bloquer l'acc√®s au shell, permettant d'encore plus r√©duire la surface d'attaque d'un attaquant.</p>
<p>Cependant, l'absence de shell peut √™tre contraignante. Il peut √™tre n√©cessaire, en fonction de vos besoins, pour ex√©cuter des scripts ou d√©boguer des conteneurs.</p>
<blockquote>
<p><strong>Note</strong> :</p>
<p>Ce n'est pas un probl√®me si vous utilisez Kubernetes version v1.25+, qui permet de cr√©er des conteneurs √©ph√©m√®res permettant de fournir un shell et diff√©rents outils √† un autre conteneurs.</p>
</blockquote>
<p>En fin de compte, c'est √† vous de peser le pour et le contre. Alpine et Debian, bien qu'ils embarquent tout ce que l'OS a besoin et plus encore, permettent m√™me une fois le conteneur lanc√© de pouvoir agir dessus, via l'installation de paquets, le lancement de scripts, la modification de configuration‚Ä¶</p>
<p>Je pense, √† titre purement personnel, que le Distroless peut √™tre pratique pour le d√©ploiement en pr√©production et production, car normalement quand votre application finit en production, elle est d√©j√† pass√©e par toutes les phases de tests.</p>
<p>Pour les phases de recette, int√©gration, test‚Ä¶ un conteneur plus basique semble √™tre le plus adapt√©, car ce sont les phases o√π le d√©bogage est le plus important.</p>
<h2 id="liens-utiles" tabindex="-1">Liens utiles</h2>
<ul>
<li>Github Google Distroless : <a href="https://github.com/GoogleContainerTools/distroless">https://github.com/GoogleContainerTools/distroless</a></li>
<li>Github Wolfi : <a href="https://github.com/wolfi-dev">https://github.com/wolfi-dev</a></li>
<li>Article de Chainguard sur le distroless : <a href="https://www.chainguard.dev/unchained/minimal-container-images-towards-a-more-secure-future">https://www.chainguard.dev/unchained/minimal-container-images-towards-a-more-secure-future</a></li>
<li>Conf√©rence sur le distroless : <a href="https://youtu.be/lviLZFciDv4?si=st4pYmcT7wZ2yG-d">https://youtu.be/lviLZFciDv4?si=st4pYmcT7wZ2yG-d</a></li>
<li>Plus sur FROM Scratch : <a href="https://docs.docker.com/build/building/base-images/">https://docs.docker.com/build/building/base-images/</a></li>
</ul>

        </div>

        <hr>
        
        <div class="article-end">
            <p>Merci d'avoir lu cet article, n'h√©sitez pas √† jeter un coup d'oeil aux autres articles.</p>
            <a class="link-to-articles" href="https://bastienbyra.fr/">Mes autres articles.</a>
            <div class="article-social-network">
                <p>par <span class="blueviolet">Bastien BYRA</span></p>
                <div class="article-network-image">
                    <a href="https://github.com/BastienBYRA">
                        <img src="/assets/social_network/Github.png" alt="Logo de Github" />
                    </a>
                    <a href="https://www.linkedin.com/in/bastien-byra-848998209/">
                        <img src="/assets/social_network/Linkedin.png" alt="Logo de Linkedin" />
                    </a>
                </div>
            </div>
        </div>
    </div>

      </div>
    </div>
  </body>
</html>